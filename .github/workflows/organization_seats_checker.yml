on: [pull_request]

jobs:
  job:
    runs-on: ubuntu-latest
    name: A job to show seats
    steps:
      - uses: actions/checkout@v2

      - name: Install hcl2json
        run: brew install hcl2json

      - name: Set up ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7

      - name: Count seats and members
        id: seats_members
        uses: M-Yamashita01/check-members@enabled_checking_member_existence_for_test
        with:
          verify_existence_account: true
        env:
          ACCESS_TOKEN: ${{ secrets.GH_ADMIN_ACCESS_TOKEN }}
          TERRAFORM_DIRECTORY_PATH: '${{ github.workspace }}'
          ORGANIZATION_NAME: 'my-organization-sandbox'

      - name: Post comments
        uses: actions/github-script@v5
        with:
          script: |
            var output = `Current seats in organization and members in terraform files.\n
              ・Seats that membership used:: ${{steps.seats_members.outputs.filled_seats}}\n
              ・Max seats an organization can use: ${{steps.seats_members.outputs.max_seats}}\n
              ・Total number of membership in terraform files: ${{steps.seats_members.outputs.members_in_terraform}}\n\n
            `
            const numberOfSeatsInShortage = ${{steps.seats_members.outputs.members_in_terraform}} - ${{steps.seats_members.outputs.max_seats}}
            var additional_message = `There is no shortage of seats.\n`
            if (numberOfSeatsInShortage > 0) {
              additional_message = `There are ${numberOfSeatsInShortage} seats missing. Please add seats.\n`
            }

            var notify_non_existing_member_message = ``
            const non_existing_members = ${{steps.seats_members.outputs.non_existing_members}}
            if (non_existing_members.length > 0) {
              notify_non_existing_member_message = `Some members in terraform files do not exist. Non-existing members: ${non_existing_members} .\n`
            }

            output += additional_message
            output += notify_non_existing_member_message
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })